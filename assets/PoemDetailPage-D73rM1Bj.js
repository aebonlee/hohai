import{r as d,j as t,M as T,s as k,f as O,L as w,e as I,g as D,b as $,h as L,P as M,H as F,i as q,C as H,k as G}from"./index-CNhTrOr2.js";import{i as A,D as P}from"./LyricsEffects-BhO46jz4.js";import{P as Y}from"./PoemReaderMode-hELB9l9O.js";import{L as U,S as W}from"./LikeButton-zzio4th6.js";import{f as J}from"./formatDate-teZXCzp_.js";function K({mood:m}){const e=d.useRef(null),x=d.useRef(0),i=d.useRef(null),f=d.useRef(null),h=d.useCallback(a=>{const _=Math.min(window.devicePixelRatio||1,2),p=a.parentElement;if(!p)return;const u=p.getBoundingClientRect();a.width=u.width*_,a.height=u.height*_,a.style.width=`${u.width}px`,a.style.height=`${u.height}px`,i.current=A(u.width,u.height),f.current=m},[m]);return d.useEffect(()=>{const a=e.current;if(!a)return;const _=a.getContext("2d");if(!_)return;const p=()=>h(a);if(p(),window.addEventListener("resize",p),f.current!==m){const g=a.parentElement;if(g){const r=g.getBoundingClientRect();i.current=A(r.width,r.height)}f.current=m}const u=T[m],l=P[m]??P.default,c=()=>{const g=a.parentElement;if(!g){x.current=requestAnimationFrame(c);return}const r=g.getBoundingClientRect(),j=r.width,y=r.height,z=performance.now(),v=i.current;if(!v){x.current=requestAnimationFrame(c);return}const N=Math.min(window.devicePixelRatio||1,2);_.setTransform(N,0,0,N,0,0),l(_,j,y,z,v,u),x.current=requestAnimationFrame(c)};return x.current=requestAnimationFrame(c),()=>{cancelAnimationFrame(x.current),window.removeEventListener("resize",p)}},[m,h]),t.jsx("canvas",{ref:e,style:{position:"absolute",inset:0,width:"100%",height:"100%",zIndex:1,pointerEvents:"none",opacity:.3}})}function Q(m,e){const[x,i]=d.useState([]),[f,h]=d.useState(!0),a=d.useCallback(async()=>{if(!e)return;h(!0);const{data:l}=await k.from("hohai_comments").select("*").eq("target_type",m).eq("target_id",e).order("created_at",{ascending:!1});i(l||[]),h(!1)},[m,e]);return d.useEffect(()=>{a()},[a]),{comments:x,loading:f,addComment:async l=>{const{error:c}=await k.from("hohai_comments").insert(l);return c||await a(),{error:c}},updateComment:async(l,c)=>{const{error:g}=await k.from("hohai_comments").update({content:c,updated_at:new Date().toISOString()}).eq("id",l);return g||await a(),{error:g}},deleteComment:async l=>{const{error:c}=await k.from("hohai_comments").delete().eq("id",l);return c||await a(),{error:c}},refetch:a}}const V="_section_6tbth_1",X="_title_6tbth_13",Z="_loginPrompt_6tbth_31",tt="_loginLink_6tbth_59",et="_form_6tbth_71",nt="_textarea_6tbth_79",st="_formActions_6tbth_117",at="_submitBtn_6tbth_131",ct="_list_6tbth_177",ot="_comment_6tbth_189",it="_commentHeader_6tbth_201",rt="_commentAuthor_6tbth_215",lt="_commentMeta_6tbth_227",mt="_commentDate_6tbth_239",dt="_commentContent_6tbth_249",_t="_actionBtn_6tbth_265",ht="_editTextarea_6tbth_305",ut="_editActions_6tbth_331",gt="_empty_6tbth_343",xt="_feedback_6tbth_357",pt="_success_6tbth_371",ft="_error_6tbth_383",n={section:V,title:X,loginPrompt:Z,loginLink:tt,form:et,textarea:nt,formActions:st,submitBtn:at,list:ct,comment:ot,commentHeader:it,commentAuthor:rt,commentMeta:lt,commentDate:mt,commentContent:dt,actionBtn:_t,delete:"_delete_6tbth_295",editTextarea:ht,editActions:ut,empty:gt,feedback:xt,success:pt,error:ft};function bt({targetType:m,targetId:e}){const{isLoggedIn:x,user:i,profile:f}=O(),{comments:h,loading:a,addComment:_,updateComment:p,deleteComment:u}=Q(m,e),[l,c]=d.useState(""),[g,r]=d.useState(!1),[j,y]=d.useState(null),[z,v]=d.useState(null),[N,R]=d.useState(""),C=(o,b="success")=>{y({type:b,message:o}),setTimeout(()=>y(null),3e3)},S=async o=>{if(o.preventDefault(),!l.trim()||!i)return;r(!0);const{error:b}=await _({user_id:i.id,target_type:m,target_id:e,content:l.trim(),author_name:(f==null?void 0:f.display_name)||i.email||"익명"});b?C("댓글 등록에 실패했습니다.","error"):(c(""),C("댓글이 등록되었습니다.")),r(!1)},B=async o=>{if(!N.trim())return;const{error:b}=await p(o,N.trim());b?C("수정에 실패했습니다.","error"):(v(null),R(""),C("댓글이 수정되었습니다."))},E=async o=>{if(!window.confirm("댓글을 삭제하시겠습니까?"))return;const{error:b}=await u(o);b?C("삭제에 실패했습니다.","error"):C("댓글이 삭제되었습니다.")};return t.jsxs("div",{className:n.section,children:[t.jsxs("h3",{className:n.title,children:["댓글 ",h.length>0&&`(${h.length})`]}),j&&t.jsx("div",{className:`${n.feedback} ${n[j.type]}`,children:j.message}),x?t.jsxs("form",{className:n.form,onSubmit:S,children:[t.jsx("textarea",{className:n.textarea,placeholder:"댓글을 작성해주세요...",value:l,onChange:o=>c(o.target.value),maxLength:1e3,rows:3}),t.jsx("div",{className:n.formActions,children:t.jsx("button",{type:"submit",className:n.submitBtn,disabled:g||!l.trim(),children:g?"등록 중...":"등록"})})]}):t.jsxs("div",{className:n.loginPrompt,children:[t.jsx("p",{children:"로그인 후 댓글을 남겨주세요"}),t.jsx(w,{to:"/login",className:n.loginLink,children:"로그인하기"})]}),a?t.jsx("p",{className:n.empty,children:"불러오는 중..."}):h.length>0?t.jsx("div",{className:n.list,children:h.map(o=>t.jsxs("div",{className:n.comment,children:[t.jsxs("div",{className:n.commentHeader,children:[t.jsx("span",{className:n.commentAuthor,children:o.author_name}),t.jsxs("div",{className:n.commentMeta,children:[t.jsx("span",{className:n.commentDate,children:J(o.created_at)}),x&&(i==null?void 0:i.id)===o.user_id&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:n.actionBtn,onClick:()=>{v(o.id),R(o.content)},children:"수정"}),t.jsx("button",{className:`${n.actionBtn} ${n.delete}`,onClick:()=>E(o.id),children:"삭제"})]})]})]}),z===o.id?t.jsxs(t.Fragment,{children:[t.jsx("textarea",{className:n.editTextarea,value:N,onChange:b=>R(b.target.value),maxLength:1e3}),t.jsxs("div",{className:n.editActions,children:[t.jsx("button",{className:n.submitBtn,onClick:()=>B(o.id),style:{padding:"4px 12px",fontSize:"0.8rem"},children:"저장"}),t.jsx("button",{className:n.actionBtn,onClick:()=>v(null),children:"취소"})]})]}):t.jsx("p",{className:n.commentContent,children:o.content})]},o.id))}):t.jsx("p",{className:n.empty,children:"아직 댓글이 없습니다. 첫 번째 댓글을 남겨주세요!"})]})}const jt="_page_13coz_1",vt="_inner_13coz_15",Nt="_backLink_13coz_40",Ct="_category_13coz_54",wt="_title_13coz_63",yt="_meta_13coz_72",kt="_content_13coz_78",zt="_stanza_13coz_87",Rt="_tags_13coz_95",Lt="_tag_13coz_95",At="_tagPlain_13coz_121",Pt="_actions_13coz_130",St="_readerBtn_13coz_137",Bt="_nav_13coz_165",Et="_navItem_13coz_174",Tt="_navLabel_13coz_186",Ot="_navTitle_13coz_191",It="_navRight_13coz_200",Dt="_loading_13coz_205",s={page:jt,inner:vt,backLink:Nt,category:Ct,title:wt,meta:yt,content:kt,stanza:zt,tags:Rt,tag:Lt,tagPlain:At,actions:Pt,readerBtn:St,nav:Bt,navItem:Et,navLabel:Tt,navTitle:Ot,navRight:It,loading:Dt};function Gt(){const{id:m}=I(),{poem:e,loading:x,adjacentPoems:i}=D(m),[f,h]=d.useState(!1),a=!!(e!=null&&e.series_id),{poems:_}=$(void 0,(e==null?void 0:e.series_id)||void 0,!1,void 0,a),p=_.findIndex(r=>r.id===m);if(x)return t.jsx("div",{className:s.loading,children:"불러오는 중..."});if(!e)return t.jsxs("div",{className:s.loading,children:["시를 찾을 수 없습니다.",t.jsx("br",{}),t.jsx(w,{to:"/poems",style:{color:"var(--accent-gold)",marginTop:16,display:"inline-block"},children:"시 목록으로 돌아가기"})]});const u=e.content.split(/\n\s*\n/).filter(Boolean),l=L[e.category]?e.category:"default",c=L[l],g=q[l];return t.jsxs(M,{children:[t.jsxs(F,{children:[t.jsxs("title",{children:[e.title," — 호해"]}),t.jsx("meta",{name:"description",content:e.excerpt||e.content.slice(0,120)})]}),t.jsxs("div",{className:s.page,style:{"--poem-bg1":c.c1,"--poem-bg2":c.c2,"--poem-bg3":c.c3,"--poem-bg4":c.c4,"--mood-accent":g},children:[t.jsx(K,{mood:l}),t.jsxs("div",{className:s.inner,children:[t.jsx(w,{to:"/poems",className:s.backLink,children:"← 시 목록으로"}),t.jsx("div",{className:s.category,style:{color:H[e.category]},children:e.category}),t.jsx("h1",{className:s.title,children:e.title}),e.written_date&&t.jsx("p",{className:s.meta,children:e.written_date}),t.jsx("div",{className:s.content,children:u.map((r,j)=>t.jsx("div",{className:s.stanza,children:r},j))}),e.tags&&e.tags.length>0&&t.jsx("div",{className:s.tags,children:e.tags.map(r=>G.includes(r)?t.jsxs(w,{to:`/poems?tag=${encodeURIComponent(r)}`,className:s.tag,children:["#",r]},r):t.jsxs("span",{className:s.tagPlain,children:["#",r]},r))}),t.jsxs("div",{className:s.actions,children:[t.jsx(U,{targetType:"poem",targetId:e.id}),t.jsx(W,{title:e.title,text:e.excerpt||e.content.slice(0,100)}),e.series_id&&_.length>1&&t.jsx("button",{className:s.readerBtn,onClick:()=>h(!0),children:"읽기 모드"})]}),t.jsx(bt,{targetType:"poem",targetId:e.id}),t.jsxs("nav",{className:s.nav,children:[i.prev?t.jsxs(w,{to:`/poems/${i.prev.id}`,className:s.navItem,children:[t.jsx("span",{className:s.navLabel,children:"← 이전 시"}),t.jsx("span",{className:s.navTitle,children:i.prev.title})]}):t.jsx("div",{}),i.next?t.jsxs(w,{to:`/poems/${i.next.id}`,className:`${s.navItem} ${s.navRight}`,children:[t.jsx("span",{className:s.navLabel,children:"다음 시 →"}),t.jsx("span",{className:s.navTitle,children:i.next.title})]}):t.jsx("div",{})]})]})]}),e.series_id&&_.length>1&&t.jsx(Y,{poems:_,initialIndex:p>=0?p:0,isOpen:f,onClose:()=>h(!1)})]})}export{Gt as default};

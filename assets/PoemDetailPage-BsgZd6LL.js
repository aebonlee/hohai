import{r as d,j as e,M as O,s as k,f as I,L as C,e as D,g as $,b as M,h as S,P as F,H as z,i as q,C as H,k as G}from"./index-CE2Wc_m1.js";import{i as A,D as P}from"./LyricsEffects-PBThZKOr.js";import{P as Y}from"./PoemReaderMode-l2NaiNSv.js";import{L as U,S as V}from"./LikeButton-DVnaNU1Y.js";import{f as W}from"./formatDate-teZXCzp_.js";import{u as J}from"./useViewCount-ClEcGSnf.js";function K({mood:m}){const t=d.useRef(null),x=d.useRef(0),o=d.useRef(null),f=d.useRef(null),h=d.useCallback(a=>{const _=Math.min(window.devicePixelRatio||1,2),g=a.parentElement;if(!g)return;const p=g.getBoundingClientRect();a.width=p.width*_,a.height=p.height*_,a.style.width=`${p.width}px`,a.style.height=`${p.height}px`,o.current=A(p.width,p.height),f.current=m},[m]);return d.useEffect(()=>{const a=t.current;if(!a)return;const _=a.getContext("2d");if(!_)return;const g=()=>h(a);if(g(),window.addEventListener("resize",g),f.current!==m){const u=a.parentElement;if(u){const r=u.getBoundingClientRect();o.current=A(r.width,r.height)}f.current=m}const p=O[m],l=P[m]??P.default,i=()=>{const u=a.parentElement;if(!u){x.current=requestAnimationFrame(i);return}const r=u.getBoundingClientRect(),b=r.width,w=r.height,R=performance.now(),v=o.current;if(!v){x.current=requestAnimationFrame(i);return}const y=Math.min(window.devicePixelRatio||1,2);_.setTransform(y,0,0,y,0,0),l(_,b,w,R,v,p),x.current=requestAnimationFrame(i)};return x.current=requestAnimationFrame(i),()=>{cancelAnimationFrame(x.current),window.removeEventListener("resize",g)}},[m,h]),e.jsx("canvas",{ref:t,style:{position:"absolute",inset:0,width:"100%",height:"100%",zIndex:1,pointerEvents:"none",opacity:.3}})}function Q(m,t){const[x,o]=d.useState([]),[f,h]=d.useState(!0),a=d.useCallback(async()=>{if(!t)return;h(!0);const{data:l}=await k.from("hohai_comments").select("*").eq("target_type",m).eq("target_id",t).order("created_at",{ascending:!1});o(l||[]),h(!1)},[m,t]);return d.useEffect(()=>{a()},[a]),{comments:x,loading:f,addComment:async l=>{const{error:i}=await k.from("hohai_comments").insert(l);return i||await a(),{error:i}},updateComment:async(l,i)=>{const{error:u}=await k.from("hohai_comments").update({content:i,updated_at:new Date().toISOString()}).eq("id",l);return u||await a(),{error:u}},deleteComment:async l=>{const{error:i}=await k.from("hohai_comments").delete().eq("id",l);return i||await a(),{error:i}},refetch:a}}const X="_section_mhya8_1",Z="_title_mhya8_7",ee="_loginPrompt_mhya8_16",te="_loginLink_mhya8_30",ne="_form_mhya8_36",se="_textarea_mhya8_40",ae="_formActions_mhya8_59",ie="_submitBtn_mhya8_66",ce="_list_mhya8_89",oe="_comment_mhya8_95",re="_commentHeader_mhya8_101",le="_commentAuthor_mhya8_108",me="_commentMeta_mhya8_114",de="_commentDate_mhya8_120",_e="_commentContent_mhya8_125",he="_actionBtn_mhya8_133",pe="_editTextarea_mhya8_153",ue="_editActions_mhya8_166",xe="_empty_mhya8_172",ge="_feedback_mhya8_179",fe="_success_mhya8_186",je="_error_mhya8_192",n={section:X,title:Z,loginPrompt:ee,loginLink:te,form:ne,textarea:se,formActions:ae,submitBtn:ie,list:ce,comment:oe,commentHeader:re,commentAuthor:le,commentMeta:me,commentDate:de,commentContent:_e,actionBtn:he,delete:"_delete_mhya8_148",editTextarea:pe,editActions:ue,empty:xe,feedback:ge,success:fe,error:je};function be({targetType:m,targetId:t}){const{isLoggedIn:x,user:o,profile:f}=I(),{comments:h,loading:a,addComment:_,updateComment:g,deleteComment:p}=Q(m,t),[l,i]=d.useState(""),[u,r]=d.useState(!1),[b,w]=d.useState(null),[R,v]=d.useState(null),[y,L]=d.useState(""),N=(c,j="success")=>{w({type:j,message:c}),setTimeout(()=>w(null),3e3)},B=async c=>{if(c.preventDefault(),!l.trim()||!o)return;r(!0);const{error:j}=await _({user_id:o.id,target_type:m,target_id:t,content:l.trim(),author_name:(f==null?void 0:f.display_name)||o.email||"익명"});j?N("댓글 등록에 실패했습니다.","error"):(i(""),N("댓글이 등록되었습니다.")),r(!1)},E=async c=>{if(!y.trim())return;const{error:j}=await g(c,y.trim());j?N("수정에 실패했습니다.","error"):(v(null),L(""),N("댓글이 수정되었습니다."))},T=async c=>{if(!window.confirm("댓글을 삭제하시겠습니까?"))return;const{error:j}=await p(c);j?N("삭제에 실패했습니다.","error"):N("댓글이 삭제되었습니다.")};return e.jsxs("div",{className:n.section,children:[e.jsxs("h3",{className:n.title,children:["댓글 ",h.length>0&&`(${h.length})`]}),b&&e.jsx("div",{className:`${n.feedback} ${n[b.type]}`,children:b.message}),x?e.jsxs("form",{className:n.form,onSubmit:B,children:[e.jsx("textarea",{className:n.textarea,placeholder:"댓글을 작성해주세요...",value:l,onChange:c=>i(c.target.value),maxLength:1e3,rows:3}),e.jsx("div",{className:n.formActions,children:e.jsx("button",{type:"submit",className:n.submitBtn,disabled:u||!l.trim(),children:u?"등록 중...":"등록"})})]}):e.jsxs("div",{className:n.loginPrompt,children:[e.jsx("p",{children:"로그인 후 댓글을 남겨주세요"}),e.jsx(C,{to:"/login",className:n.loginLink,children:"로그인하기"})]}),a?e.jsx("p",{className:n.empty,children:"불러오는 중..."}):h.length>0?e.jsx("div",{className:n.list,children:h.map(c=>e.jsxs("div",{className:n.comment,children:[e.jsxs("div",{className:n.commentHeader,children:[e.jsx("span",{className:n.commentAuthor,children:c.author_name}),e.jsxs("div",{className:n.commentMeta,children:[e.jsx("span",{className:n.commentDate,children:W(c.created_at)}),x&&(o==null?void 0:o.id)===c.user_id&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:n.actionBtn,onClick:()=>{v(c.id),L(c.content)},children:"수정"}),e.jsx("button",{className:`${n.actionBtn} ${n.delete}`,onClick:()=>T(c.id),children:"삭제"})]})]})]}),R===c.id?e.jsxs(e.Fragment,{children:[e.jsx("textarea",{className:n.editTextarea,value:y,onChange:j=>L(j.target.value),maxLength:1e3}),e.jsxs("div",{className:n.editActions,children:[e.jsx("button",{className:n.submitBtn,onClick:()=>E(c.id),style:{padding:"4px 12px",fontSize:"0.8rem"},children:"저장"}),e.jsx("button",{className:n.actionBtn,onClick:()=>v(null),children:"취소"})]})]}):e.jsx("p",{className:n.commentContent,children:c.content})]},c.id))}):e.jsx("p",{className:n.empty,children:"아직 댓글이 없습니다. 첫 번째 댓글을 남겨주세요!"})]})}const ve="_page_epptb_1",ye="_inner_epptb_15",Ne="_backLink_epptb_40",Ce="_category_epptb_54",we="_title_epptb_63",ke="_meta_epptb_72",Re="_metaSep_epptb_78",Le="_content_epptb_82",Se="_stanza_epptb_91",Ae="_tags_epptb_99",Pe="_tag_epptb_99",Be="_tagPlain_epptb_125",Ee="_actions_epptb_134",Te="_readerBtn_epptb_141",Oe="_nav_epptb_169",Ie="_navItem_epptb_178",De="_navLabel_epptb_190",$e="_navTitle_epptb_195",Me="_navRight_epptb_204",Fe="_loading_epptb_209",s={page:ve,inner:ye,backLink:Ne,category:Ce,title:we,meta:ke,metaSep:Re,content:Le,stanza:Se,tags:Ae,tag:Pe,tagPlain:Be,actions:Ee,readerBtn:Te,nav:Oe,navItem:Ie,navLabel:De,navTitle:$e,navRight:Me,loading:Fe};function Ve(){const{id:m}=D(),{poem:t,loading:x,adjacentPoems:o}=$(m),[f,h]=d.useState(!1);J("hohai_poems",m);const a=!!(t!=null&&t.series_id),{poems:_}=M(void 0,(t==null?void 0:t.series_id)||void 0,!1,void 0,a),g=_.findIndex(r=>r.id===m);if(x)return e.jsx("div",{className:s.loading,children:"불러오는 중..."});if(!t)return e.jsxs("div",{className:s.loading,children:["시를 찾을 수 없습니다.",e.jsx("br",{}),e.jsx(C,{to:"/poems",style:{color:"var(--accent-gold)",marginTop:16,display:"inline-block"},children:"시 목록으로 돌아가기"})]});const p=t.content.split(/\n\s*\n/).filter(Boolean),l=S[t.category]?t.category:"default",i=S[l],u=q[l];return e.jsxs(F,{children:[e.jsxs(z,{children:[e.jsxs("title",{children:[t.title," — 호해"]}),e.jsx("meta",{name:"description",content:t.excerpt||t.content.slice(0,120)})]}),e.jsxs("div",{className:s.page,style:{"--poem-bg1":i.c1,"--poem-bg2":i.c2,"--poem-bg3":i.c3,"--poem-bg4":i.c4,"--mood-accent":u},children:[e.jsx(K,{mood:l}),e.jsxs("div",{className:s.inner,children:[e.jsx(C,{to:"/poems",className:s.backLink,children:"← 시 목록으로"}),e.jsx("div",{className:s.category,style:{color:H[t.category]},children:t.category}),e.jsx("h1",{className:s.title,children:t.title}),e.jsxs("p",{className:s.meta,children:[t.written_date&&e.jsx("span",{children:t.written_date}),t.written_date&&e.jsx("span",{className:s.metaSep,children:" · "}),e.jsxs("span",{children:["조회 ",t.view_count??0]})]}),e.jsx("div",{className:s.content,children:p.map((r,b)=>e.jsx("div",{className:s.stanza,children:r},b))}),t.tags&&t.tags.length>0&&e.jsx("div",{className:s.tags,children:t.tags.map(r=>G.includes(r)?e.jsxs(C,{to:`/poems?tag=${encodeURIComponent(r)}`,className:s.tag,children:["#",r]},r):e.jsxs("span",{className:s.tagPlain,children:["#",r]},r))}),e.jsxs("div",{className:s.actions,children:[e.jsx(U,{targetType:"poem",targetId:t.id}),e.jsx(V,{title:t.title,text:t.excerpt||t.content.slice(0,100)}),t.series_id&&_.length>1&&e.jsx("button",{className:s.readerBtn,onClick:()=>h(!0),children:"읽기 모드"})]}),e.jsx(be,{targetType:"poem",targetId:t.id}),e.jsxs("nav",{className:s.nav,children:[o.prev?e.jsxs(C,{to:`/poems/${o.prev.id}`,className:s.navItem,children:[e.jsx("span",{className:s.navLabel,children:"← 이전 시"}),e.jsx("span",{className:s.navTitle,children:o.prev.title})]}):e.jsx("div",{}),o.next?e.jsxs(C,{to:`/poems/${o.next.id}`,className:`${s.navItem} ${s.navRight}`,children:[e.jsx("span",{className:s.navLabel,children:"다음 시 →"}),e.jsx("span",{className:s.navTitle,children:o.next.title})]}):e.jsx("div",{})]})]})]}),t.series_id&&_.length>1&&e.jsx(Y,{poems:_,initialIndex:g>=0?g:0,isOpen:f,onClose:()=>h(!1)})]})}export{Ve as default};

import{r as d,j as e,M as T,s as k,f as O,L as C,e as I,g as D,b as $,h as L,P as M,H as F,i as q,C as H,k as G}from"./index-BvDDahVw.js";import{i as A,D as P}from"./LyricsEffects-CccY5AI3.js";import{P as Y}from"./PoemReaderMode-BHZDbOoM.js";import{L as U,S as W}from"./LikeButton-CFU3rHrt.js";import{f as J}from"./formatDate-teZXCzp_.js";function K({mood:m}){const t=d.useRef(null),x=d.useRef(0),i=d.useRef(null),f=d.useRef(null),h=d.useCallback(a=>{const _=Math.min(window.devicePixelRatio||1,2),p=a.parentElement;if(!p)return;const u=p.getBoundingClientRect();a.width=u.width*_,a.height=u.height*_,a.style.width=`${u.width}px`,a.style.height=`${u.height}px`,i.current=A(u.width,u.height),f.current=m},[m]);return d.useEffect(()=>{const a=t.current;if(!a)return;const _=a.getContext("2d");if(!_)return;const p=()=>h(a);if(p(),window.addEventListener("resize",p),f.current!==m){const g=a.parentElement;if(g){const r=g.getBoundingClientRect();i.current=A(r.width,r.height)}f.current=m}const u=T[m],l=P[m]??P.default,c=()=>{const g=a.parentElement;if(!g){x.current=requestAnimationFrame(c);return}const r=g.getBoundingClientRect(),v=r.width,w=r.height,z=performance.now(),y=i.current;if(!y){x.current=requestAnimationFrame(c);return}const N=Math.min(window.devicePixelRatio||1,2);_.setTransform(N,0,0,N,0,0),l(_,v,w,z,y,u),x.current=requestAnimationFrame(c)};return x.current=requestAnimationFrame(c),()=>{cancelAnimationFrame(x.current),window.removeEventListener("resize",p)}},[m,h]),e.jsx("canvas",{ref:t,style:{position:"absolute",inset:0,width:"100%",height:"100%",zIndex:1,pointerEvents:"none",opacity:.3}})}function Q(m,t){const[x,i]=d.useState([]),[f,h]=d.useState(!0),a=d.useCallback(async()=>{if(!t)return;h(!0);const{data:l}=await k.from("hohai_comments").select("*").eq("target_type",m).eq("target_id",t).order("created_at",{ascending:!1});i(l||[]),h(!1)},[m,t]);return d.useEffect(()=>{a()},[a]),{comments:x,loading:f,addComment:async l=>{const{error:c}=await k.from("hohai_comments").insert(l);return c||await a(),{error:c}},updateComment:async(l,c)=>{const{error:g}=await k.from("hohai_comments").update({content:c,updated_at:new Date().toISOString()}).eq("id",l);return g||await a(),{error:g}},deleteComment:async l=>{const{error:c}=await k.from("hohai_comments").delete().eq("id",l);return c||await a(),{error:c}},refetch:a}}const V="_section_mhya8_1",X="_title_mhya8_7",Z="_loginPrompt_mhya8_16",ee="_loginLink_mhya8_30",te="_form_mhya8_36",ne="_textarea_mhya8_40",se="_formActions_mhya8_59",ae="_submitBtn_mhya8_66",ce="_list_mhya8_89",oe="_comment_mhya8_95",ie="_commentHeader_mhya8_101",re="_commentAuthor_mhya8_108",le="_commentMeta_mhya8_114",me="_commentDate_mhya8_120",de="_commentContent_mhya8_125",_e="_actionBtn_mhya8_133",he="_editTextarea_mhya8_153",ue="_editActions_mhya8_166",ge="_empty_mhya8_172",xe="_feedback_mhya8_179",pe="_success_mhya8_186",fe="_error_mhya8_192",n={section:V,title:X,loginPrompt:Z,loginLink:ee,form:te,textarea:ne,formActions:se,submitBtn:ae,list:ce,comment:oe,commentHeader:ie,commentAuthor:re,commentMeta:le,commentDate:me,commentContent:de,actionBtn:_e,delete:"_delete_mhya8_148",editTextarea:he,editActions:ue,empty:ge,feedback:xe,success:pe,error:fe};function je({targetType:m,targetId:t}){const{isLoggedIn:x,user:i,profile:f}=O(),{comments:h,loading:a,addComment:_,updateComment:p,deleteComment:u}=Q(m,t),[l,c]=d.useState(""),[g,r]=d.useState(!1),[v,w]=d.useState(null),[z,y]=d.useState(null),[N,R]=d.useState(""),b=(o,j="success")=>{w({type:j,message:o}),setTimeout(()=>w(null),3e3)},S=async o=>{if(o.preventDefault(),!l.trim()||!i)return;r(!0);const{error:j}=await _({user_id:i.id,target_type:m,target_id:t,content:l.trim(),author_name:(f==null?void 0:f.display_name)||i.email||"익명"});j?b("댓글 등록에 실패했습니다.","error"):(c(""),b("댓글이 등록되었습니다.")),r(!1)},B=async o=>{if(!N.trim())return;const{error:j}=await p(o,N.trim());j?b("수정에 실패했습니다.","error"):(y(null),R(""),b("댓글이 수정되었습니다."))},E=async o=>{if(!window.confirm("댓글을 삭제하시겠습니까?"))return;const{error:j}=await u(o);j?b("삭제에 실패했습니다.","error"):b("댓글이 삭제되었습니다.")};return e.jsxs("div",{className:n.section,children:[e.jsxs("h3",{className:n.title,children:["댓글 ",h.length>0&&`(${h.length})`]}),v&&e.jsx("div",{className:`${n.feedback} ${n[v.type]}`,children:v.message}),x?e.jsxs("form",{className:n.form,onSubmit:S,children:[e.jsx("textarea",{className:n.textarea,placeholder:"댓글을 작성해주세요...",value:l,onChange:o=>c(o.target.value),maxLength:1e3,rows:3}),e.jsx("div",{className:n.formActions,children:e.jsx("button",{type:"submit",className:n.submitBtn,disabled:g||!l.trim(),children:g?"등록 중...":"등록"})})]}):e.jsxs("div",{className:n.loginPrompt,children:[e.jsx("p",{children:"로그인 후 댓글을 남겨주세요"}),e.jsx(C,{to:"/login",className:n.loginLink,children:"로그인하기"})]}),a?e.jsx("p",{className:n.empty,children:"불러오는 중..."}):h.length>0?e.jsx("div",{className:n.list,children:h.map(o=>e.jsxs("div",{className:n.comment,children:[e.jsxs("div",{className:n.commentHeader,children:[e.jsx("span",{className:n.commentAuthor,children:o.author_name}),e.jsxs("div",{className:n.commentMeta,children:[e.jsx("span",{className:n.commentDate,children:J(o.created_at)}),x&&(i==null?void 0:i.id)===o.user_id&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:n.actionBtn,onClick:()=>{y(o.id),R(o.content)},children:"수정"}),e.jsx("button",{className:`${n.actionBtn} ${n.delete}`,onClick:()=>E(o.id),children:"삭제"})]})]})]}),z===o.id?e.jsxs(e.Fragment,{children:[e.jsx("textarea",{className:n.editTextarea,value:N,onChange:j=>R(j.target.value),maxLength:1e3}),e.jsxs("div",{className:n.editActions,children:[e.jsx("button",{className:n.submitBtn,onClick:()=>B(o.id),style:{padding:"4px 12px",fontSize:"0.8rem"},children:"저장"}),e.jsx("button",{className:n.actionBtn,onClick:()=>y(null),children:"취소"})]})]}):e.jsx("p",{className:n.commentContent,children:o.content})]},o.id))}):e.jsx("p",{className:n.empty,children:"아직 댓글이 없습니다. 첫 번째 댓글을 남겨주세요!"})]})}const ve="_page_13coz_1",ye="_inner_13coz_15",Ne="_backLink_13coz_40",be="_category_13coz_54",Ce="_title_13coz_63",we="_meta_13coz_72",ke="_content_13coz_78",ze="_stanza_13coz_87",Re="_tags_13coz_95",Le="_tag_13coz_95",Ae="_tagPlain_13coz_121",Pe="_actions_13coz_130",Se="_readerBtn_13coz_137",Be="_nav_13coz_165",Ee="_navItem_13coz_174",Te="_navLabel_13coz_186",Oe="_navTitle_13coz_191",Ie="_navRight_13coz_200",De="_loading_13coz_205",s={page:ve,inner:ye,backLink:Ne,category:be,title:Ce,meta:we,content:ke,stanza:ze,tags:Re,tag:Le,tagPlain:Ae,actions:Pe,readerBtn:Se,nav:Be,navItem:Ee,navLabel:Te,navTitle:Oe,navRight:Ie,loading:De};function Ge(){const{id:m}=I(),{poem:t,loading:x,adjacentPoems:i}=D(m),[f,h]=d.useState(!1),a=!!(t!=null&&t.series_id),{poems:_}=$(void 0,(t==null?void 0:t.series_id)||void 0,!1,void 0,a),p=_.findIndex(r=>r.id===m);if(x)return e.jsx("div",{className:s.loading,children:"불러오는 중..."});if(!t)return e.jsxs("div",{className:s.loading,children:["시를 찾을 수 없습니다.",e.jsx("br",{}),e.jsx(C,{to:"/poems",style:{color:"var(--accent-gold)",marginTop:16,display:"inline-block"},children:"시 목록으로 돌아가기"})]});const u=t.content.split(/\n\s*\n/).filter(Boolean),l=L[t.category]?t.category:"default",c=L[l],g=q[l];return e.jsxs(M,{children:[e.jsxs(F,{children:[e.jsxs("title",{children:[t.title," — 호해"]}),e.jsx("meta",{name:"description",content:t.excerpt||t.content.slice(0,120)})]}),e.jsxs("div",{className:s.page,style:{"--poem-bg1":c.c1,"--poem-bg2":c.c2,"--poem-bg3":c.c3,"--poem-bg4":c.c4,"--mood-accent":g},children:[e.jsx(K,{mood:l}),e.jsxs("div",{className:s.inner,children:[e.jsx(C,{to:"/poems",className:s.backLink,children:"← 시 목록으로"}),e.jsx("div",{className:s.category,style:{color:H[t.category]},children:t.category}),e.jsx("h1",{className:s.title,children:t.title}),t.written_date&&e.jsx("p",{className:s.meta,children:t.written_date}),e.jsx("div",{className:s.content,children:u.map((r,v)=>e.jsx("div",{className:s.stanza,children:r},v))}),t.tags&&t.tags.length>0&&e.jsx("div",{className:s.tags,children:t.tags.map(r=>G.includes(r)?e.jsxs(C,{to:`/poems?tag=${encodeURIComponent(r)}`,className:s.tag,children:["#",r]},r):e.jsxs("span",{className:s.tagPlain,children:["#",r]},r))}),e.jsxs("div",{className:s.actions,children:[e.jsx(U,{targetType:"poem",targetId:t.id}),e.jsx(W,{title:t.title,text:t.excerpt||t.content.slice(0,100)}),t.series_id&&_.length>1&&e.jsx("button",{className:s.readerBtn,onClick:()=>h(!0),children:"읽기 모드"})]}),e.jsx(je,{targetType:"poem",targetId:t.id}),e.jsxs("nav",{className:s.nav,children:[i.prev?e.jsxs(C,{to:`/poems/${i.prev.id}`,className:s.navItem,children:[e.jsx("span",{className:s.navLabel,children:"← 이전 시"}),e.jsx("span",{className:s.navTitle,children:i.prev.title})]}):e.jsx("div",{}),i.next?e.jsxs(C,{to:`/poems/${i.next.id}`,className:`${s.navItem} ${s.navRight}`,children:[e.jsx("span",{className:s.navLabel,children:"다음 시 →"}),e.jsx("span",{className:s.navTitle,children:i.next.title})]}):e.jsx("div",{})]})]})]}),t.series_id&&_.length>1&&e.jsx(Y,{poems:_,initialIndex:p>=0?p:0,isOpen:f,onClose:()=>h(!1)})]})}export{Ge as default};
